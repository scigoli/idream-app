<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Idream - Interprete sogni</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <style>
        body { background: #f8f9fa; }
        .dream-box { max-width: 600px; margin: 40px auto; }
        .question-box { margin-top: 30px; }
        .result-box { margin-top: 30px; }
    </style>
</head>
<body>
<div class="container dream-box">
    <h2 class="mb-4 text-center">Idream - Interprete sogni</h2>
    <div id="login-section">
        <button id="login-btn" class="btn btn-primary w-100">Accedi con Google</button>
        <div id="login-error" class="text-danger mt-2" style="display:none;"></div>
    </div>
    <div id="dream-section" style="display:none;">
        <label for="dream-input" class="form-label">Scrivi il tuo sogno:</label>
        <textarea id="dream-input" class="form-control" rows="4" placeholder="Descrivi il sogno..."></textarea>
        <button id="dream-submit" class="btn btn-success mt-3 w-100">Ottieni domande</button>
        <div id="dream-error" class="text-danger mt-2" style="display:none;"></div>
    </div>
    <div id="question-section" class="question-box" style="display:none;"></div>
    <div id="result-section" class="result-box" style="display:none;"></div>
</div>
<script>
// Configurazione Firebase

// --- LOGGING DEBUG ---
console.log('[LOG] Avvio script index.html');
const firebaseConfig = {
    apiKey: "INSERISCI_API_KEY_FIREBASE",
    authDomain: "INSERISCI_AUTH_DOMAIN",
    projectId: "INSERISCI_PROJECT_ID"
};
console.log('[LOG] Config Firebase:', firebaseConfig);
try {
    firebase.initializeApp(firebaseConfig);
    console.log('[LOG] Firebase SDK inizializzato');
} catch (e) {
    console.error('[LOG] Errore inizializzazione Firebase:', e);
}
const auth = firebase.auth();
console.log('[LOG] Firebase Auth:', auth);
let idToken = null;
let dreamText = "";
let questions = [];
let answers = [];
let currentQuestion = 0;

// Sicurezza: pulizia input
function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Login Google
const loginBtn = document.getElementById('login-btn');
if (!loginBtn) {
    console.error('[LOG] Pulsante login Google non trovato!');
} else {
    console.log('[LOG] Pulsante login Google trovato, aggiungo event listener');
    loginBtn.onclick = function() {
        console.log('[LOG] Click su pulsante Google');
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(async (result) => {
                console.log('[LOG] Login success:', result);
                if (!result.user) {
                    console.error('[LOG] Nessun utente restituito da Firebase!');
                    document.getElementById('login-error').innerText = 'Errore: nessun utente restituito da Firebase.';
                    document.getElementById('login-error').style.display = 'block';
                    return;
                }
                idToken = await result.user.getIdToken();
                console.log('[LOG] ID Token:', idToken);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dream-section').style.display = 'block';
            })
            .catch((error) => {
                console.error('[LOG] Login error:', error);
                document.getElementById('login-error').innerText = 'Errore login: ' + error.message;
                document.getElementById('login-error').style.display = 'block';
            });
    };
}

// Invio sogno
const dreamSubmit = document.getElementById('dream-submit');
dreamSubmit.onclick = async function() {
    dreamText = sanitize(document.getElementById('dream-input').value);
    if (!dreamText.trim()) {
        document.getElementById('dream-error').innerText = 'Inserisci una descrizione del sogno.';
        document.getElementById('dream-error').style.display = 'block';
        return;
    }
    document.getElementById('dream-error').style.display = 'none';
    try {
        const res = await fetch('/proxy/questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ sogno: dreamText })
        });
        if (!res.ok) throw new Error('Errore API: ' + res.status);
        const data = await res.json();
        questions = data.domande || [];
        answers = [];
        currentQuestion = 0;
        showQuestion();
        document.getElementById('dream-section').style.display = 'none';
    } catch (err) {
        document.getElementById('dream-error').innerText = err.message;
        document.getElementById('dream-error').style.display = 'block';
        console.error('API /questions error', err);
    }
};

// Wizard domande
function showQuestion() {
    const section = document.getElementById('question-section');
    section.innerHTML = '';
    if (currentQuestion < questions.length) {
        const q = sanitize(questions[currentQuestion]);
        section.innerHTML = `<div class="mb-3"><strong>Domanda ${currentQuestion+1}:</strong> ${q}</div>
            <input type="text" id="answer-input" class="form-control" placeholder="Rispondi...">
            <button id="answer-btn" class="btn btn-primary mt-3 w-100">Avanti</button>
            <div id="answer-error" class="text-danger mt-2" style="display:none;"></div>`;
        section.style.display = 'block';
        document.getElementById('answer-btn').onclick = function() {
            const ans = sanitize(document.getElementById('answer-input').value);
            if (!ans.trim()) {
                document.getElementById('answer-error').innerText = 'Rispondi alla domanda.';
                document.getElementById('answer-error').style.display = 'block';
                return;
            }
            document.getElementById('answer-error').style.display = 'none';
            answers.push([questions[currentQuestion], ans]);
            currentQuestion++;
            showQuestion();
        };
    } else {
        section.style.display = 'none';
        sendInterpretation();
    }
}

// Invio interpretazione
async function sendInterpretation() {
    try {
        const res = await fetch('/proxy/interpretation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ sogno: dreamText, risposte: answers })
        });
        if (!res.ok) throw new Error('Errore API: ' + res.status);
        const result = await res.json();
        showResult(result);
    } catch (err) {
        const section = document.getElementById('result-section');
        section.innerHTML = `<div class="alert alert-danger">${sanitize(err.message)}</div>`;
        section.style.display = 'block';
        console.error('API /interpretation error', err);
    }
}

// Visualizza risultato
function showResult(result) {
    const section = document.getElementById('result-section');
    section.innerHTML = `<div class="alert alert-success"><strong>Interpretazione:</strong><br>${sanitize(result.interpretazione || JSON.stringify(result))}</div>`;
    section.style.display = 'block';
}
</script>
</body>
</html>
