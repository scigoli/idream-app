<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Idream - Interprete sogni</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <style>
        body { background: #f8f9fa; }
        .dream-box { max-width: 600px; margin: 40px auto; }
        .question-box { margin-top: 30px; }
        .result-box { margin-top: 30px; }
    </style>
</head>
<body>
<div class="container dream-box">
    <h2 class="mb-4 text-center">Idream - Interprete sogni</h2>
        <div id="login-section" class="container mt-5">
            <h2>Accedi per interpretare il tuo sogno</h2>
            <button id="login-btn" class="btn btn-primary">Accedi con Google</button>
            <div id="user-info" class="mt-3" style="display:none">
                <span id="user-name" class="fw-bold"></span><br>
                <span id="user-email" class="text-muted"></span><br>
                <button id="logout-btn" class="btn btn-outline-secondary btn-sm mt-2" style="display:none;">Logout</button>
            </div>
        </div>
        <div id="wizard-section" class="container mt-5" style="display:none;">
            <h2>Benvenuto!</h2>
            <div id="user-info" class="mb-3"></div>
            <button id="logout-btn" class="btn btn-outline-danger mb-3" style="display:none;">Logout</button>
            <div id="step-1" style="display:block;">
                <label for="sogno-input" class="form-label">Descrivi il tuo sogno</label>
                <textarea id="sogno-input" class="form-control" rows="3"></textarea>
                <button id="next-btn" class="btn btn-success mt-3">Avanti</button>
            </div>
            <div id="step-2" style="display:none;">
                <h4>Domande</h4>
                <form id="questions-form"></form>
                <button id="submit-btn" class="btn btn-success mt-3">Ottieni interpretazione</button>
            </div>
            <div id="step-3" style="display:none;">
                <h4>Interpretazione</h4>
                <div id="interpretation-result" class="alert alert-info"></div>
            </div>
        </div>
    <div id="question-section" class="question-box" style="display:none;"></div>
    <div id="result-section" class="result-box" style="display:none;"></div>
</div>
<script>
// Collega il pulsante "Ottieni interpretazione" al flusso corretto
document.getElementById('submit-btn').onclick = async function() {
    // Raccogli le risposte dal form
    const form = document.getElementById('questions-form');
    const inputs = form.querySelectorAll('input');
    answers = [];
    let valid = true;
    inputs.forEach((input, i) => {
        const val = sanitize(input.value);
        if (!val.trim()) valid = false;
        answers.push([questions[i], val]);
    });
    if (!valid) {
        alert('Rispondi a tutte le domande.');
        return;
    }
    document.getElementById('step-2').style.display = 'none';
    document.getElementById('step-3').style.display = 'block';
    // Chiamata interpretazione
    try {
        const res = await fetch('/proxy/interpretation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ sogno: dreamText, risposte: answers })
        });
        if (!res.ok) throw new Error('Errore API: ' + res.status);
        const result = await res.json();
        document.getElementById('interpretation-result').innerHTML = sanitize(result.interpretazione || JSON.stringify(result));
    } catch (err) {
        document.getElementById('interpretation-result').innerHTML = `<span class="text-danger">${sanitize(err.message)}</span>`;
        console.error('API /interpretation error', err);
    }
};
// Configurazione Firebase

// --- LOGGING DEBUG ---
console.log('[LOG] Avvio script index.html');
const firebaseConfig = {
    apiKey: "INSERISCI_API_KEY_FIREBASE",
    authDomain: "INSERISCI_AUTH_DOMAIN",
    projectId: "INSERISCI_PROJECT_ID"
};
console.log('[LOG] Config Firebase:', firebaseConfig);
try {
    firebase.initializeApp(firebaseConfig);
    console.log('[LOG] Firebase SDK inizializzato');
} catch (e) {
    console.error('[LOG] Errore inizializzazione Firebase:', e);
}
const auth = firebase.auth();
console.log('[LOG] Firebase Auth:', auth);
let idToken = null;
let dreamText = "";
let questions = [];
let answers = [];
let currentQuestion = 0;

// Sicurezza: pulizia input
function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Login Google
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userInfoDiv = document.getElementById('user-info');
const userNameSpan = document.getElementById('user-name');
const userEmailSpan = document.getElementById('user-email');

function showUserInfo(user) {
    userInfoDiv.style.display = 'block';
    userNameSpan.textContent = user.displayName || user.email;
    userEmailSpan.textContent = user.email;
    logoutBtn.style.display = 'inline-block';
}
function hideUserInfo() {
    userInfoDiv.style.display = 'none';
    userNameSpan.textContent = '';
    userEmailSpan.textContent = '';
    logoutBtn.style.display = 'none';
}

firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        // Utente loggato
        loginBtn.style.display = 'none';
        showUserInfo(user);
        document.getElementById('wizard-section').style.display = 'block';
    } else {
        // Utente non loggato
        loginBtn.style.display = 'inline-block';
        hideUserInfo();
        document.getElementById('wizard-section').style.display = 'none';
    }
});

if (!loginBtn) {
    console.error('[LOG] Pulsante login Google non trovato!');
} else {
    console.log('[LOG] Pulsante login Google trovato, aggiungo event listener');
    loginBtn.onclick = function() {
        console.log('[LOG] Click su pulsante Google');
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(async (result) => {
                if (!result.user) {
                    console.error('[LOG] Nessun utente restituito da Firebase!');
                    return;
                }
                idToken = await result.user.getIdToken();
                document.getElementById('step-1').style.display = 'block';
                document.getElementById('step-2').style.display = 'none';
                document.getElementById('step-3').style.display = 'none';
            })
            .catch((error) => {
                console.error('[LOG] Login error:', error);
            });
    };
}

logoutBtn.onclick = function() {
    firebase.auth().signOut();
};

// Invio sogno
const dreamSubmit = document.getElementById('dream-submit');
const nextBtn = document.getElementById('next-btn');
nextBtn.onclick = async function() {
    dreamText = sanitize(document.getElementById('sogno-input').value);
    if (!dreamText.trim()) {
        alert('Inserisci una descrizione del sogno.');
        return;
    }
    try {
        const res = await fetch('/proxy/questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ sogno: dreamText })
        });
        if (!res.ok) throw new Error('Errore API: ' + res.status);
        const data = await res.json();
        questions = data.domande || [];
        answers = [];
        currentQuestion = 0;
        document.getElementById('step-1').style.display = 'none';
        document.getElementById('step-2').style.display = 'block';
        showQuestionsForm();
    } catch (err) {
        alert(err.message);
        console.error('API /questions error', err);
    }
};

function showQuestionsForm() {
    const form = document.getElementById('questions-form');
    form.innerHTML = '';
    questions.forEach((q, i) => {
        form.innerHTML += `<div class="mb-2"><label>Domanda ${i+1}: ${sanitize(q)}</label><input type="text" class="form-control" name="answer${i}" /></div>`;
    });
}

// Wizard domande
function showQuestion() {
    const section = document.getElementById('question-section');
    section.innerHTML = '';
    if (currentQuestion < questions.length) {
        const q = sanitize(questions[currentQuestion]);
        section.innerHTML = `<div class="mb-3"><strong>Domanda ${currentQuestion+1}:</strong> ${q}</div>
            <input type="text" id="answer-input" class="form-control" placeholder="Rispondi...">
            <button id="answer-btn" class="btn btn-primary mt-3 w-100">Avanti</button>
            <div id="answer-error" class="text-danger mt-2" style="display:none;"></div>`;
        section.style.display = 'block';
        document.getElementById('answer-btn').onclick = function() {
            const ans = sanitize(document.getElementById('answer-input').value);
            if (!ans.trim()) {
                document.getElementById('answer-error').innerText = 'Rispondi alla domanda.';
                document.getElementById('answer-error').style.display = 'block';
                return;
            }
            document.getElementById('answer-error').style.display = 'none';
            answers.push([questions[currentQuestion], ans]);
            currentQuestion++;
            showQuestion();
        };
    } else {
        section.style.display = 'none';
        sendInterpretation();
    }
}

// Invio interpretazione
async function sendInterpretation() {
    try {
        const res = await fetch('/proxy/interpretation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + idToken
            },
            body: JSON.stringify({ sogno: dreamText, risposte: answers })
        });
        if (!res.ok) throw new Error('Errore API: ' + res.status);
        const result = await res.json();
        showResult(result);
    } catch (err) {
        const section = document.getElementById('result-section');
        section.innerHTML = `<div class="alert alert-danger">${sanitize(err.message)}</div>`;
        section.style.display = 'block';
        console.error('API /interpretation error', err);
    }
}

// Visualizza risultato
function showResult(result) {
    const section = document.getElementById('result-section');
    section.innerHTML = `<div class="alert alert-success"><strong>Interpretazione:</strong><br>${sanitize(result.interpretazione || JSON.stringify(result))}</div>`;
    section.style.display = 'block';
}
</script>
</body>
</html>
